<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="../bower_components/threejs/build/three.js"></script>
    <script src="vendor/d3.js"></script>
    <script src="vendor/tween.min.js"></script>
    <script src="../dist/subunit.js"></script>
  </head>
  <body>
    <script id="fragment_shader4" type="x-shader/x-fragment">

      uniform float time;
      uniform vec2 resolution;

      varying vec2 vUv;

      void main( void ) {

        vec2 position = -1.0 + 2.0 * vUv;

        float red = abs( sin( position.x * position.y + time / 5.0 ) );
        float green = abs( sin( position.x * position.y + time / 4.0 ) );
        float blue = abs( sin( position.x * position.y + time / 3.0 ) );
        gl_FragColor = vec4( red, green, blue, 1.0 );

      }

    </script>

    <script id="fragment_shader3" type="x-shader/x-fragment">

      uniform float time;
      uniform vec2 resolution;

      varying vec2 vUv;

      void main( void ) {

        vec2 position = vUv;

        float color = 0.0;
        color += sin( position.x * cos( time / 15.0 ) * 80.0 ) + cos( position.y * cos( time / 15.0 ) * 10.0 );
        color += sin( position.y * sin( time / 10.0 ) * 40.0 ) + cos( position.x * sin( time / 25.0 ) * 40.0 );
        color += sin( position.x * sin( time / 5.0 ) * 10.0 ) + sin( position.y * sin( time / 35.0 ) * 80.0 );
        color *= sin( time / 10.0 ) * 0.5;

        gl_FragColor = vec4( vec3( color, color * 0.5, sin( color + time / 3.0 ) * 0.75 ), 1.0 );

      }

    </script>

    <script id="fragment_shader2" type="x-shader/x-fragment">

      uniform float time;
      uniform vec2 resolution;

      uniform sampler2D texture;

      varying vec2 vUv;

      void main( void ) {

        vec2 position = -1.0 + 2.0 * vUv;

        float a = atan( position.y, position.x );
        float r = sqrt( dot( position, position ) );

        vec2 uv;
        uv.x = cos( a ) / r;
        uv.y = sin( a ) / r;
        uv /= 10.0;
        uv += time * 0.05;

        vec3 color = texture2D( texture, uv ).rgb;

        gl_FragColor = vec4( color * r * 1.5, 1.0 );

      }
    </script>

    <script id="fragmentShader1" type="x-shader/x-fragment">

      uniform vec2 resolution;
      uniform float time;

      varying vec2 vUv;

      void main(void)
      {

        vec2 p = -1.0 + 2.0 * vUv;
        float a = time*40.0;
        float d,e,f,g=1.0/40.0,h,i,r,q;

        e=400.0*(p.x*0.5+0.5);
        f=400.0*(p.y*0.5+0.5);
        i=200.0+sin(e*g+a/150.0)*20.0;
        d=200.0+cos(f*g/2.0)*18.0+cos(e*g)*7.0;
        r=sqrt(pow(i-e,2.0)+pow(d-f,2.0));
        q=f/r;
        e=(r*cos(q))-a/2.0;f=(r*sin(q))-a/2.0;
        d=sin(e*g)*176.0+sin(e*g)*164.0+r;
        h=((f+d)+a/2.0)*g;
        i=cos(h+r*p.x/1.3)*(e+e+a)+cos(q*g*6.0)*(r+h/3.0);
        h=sin(f*g)*144.0-sin(e*g)*212.0*p.x;
        h=(h+(f-e)*q+sin(r-(a+h)/7.0)*10.0+i/4.0)*g;
        i+=cos(h*2.3*sin(a/350.0-q))*184.0*sin(q-(r*4.3+a/12.0)*g)+tan(r*g+h)*184.0*cos(r*g+h);
        i=mod(i/5.6,256.0)/64.0;
        if(i<0.0) i+=4.0;
        if(i>=2.0) i=4.0-i;
        d=r/350.0;
        d+=sin(d*d*8.0)*0.52;
        f=(sin(a*g)+1.0)/2.0;
        gl_FragColor=vec4(vec3(f*i/1.6,i/2.0+d/13.0,i)*d*p.x+vec3(i/1.3+d/8.0,i/2.0+d/18.0,i)*d*(1.0-p.x),1.0);

      }

    </script>
    <script id="vertexShader" type="x-shader/x-vertex">

      varying vec2 vUv;

      void main()
      {
        vUv = uv;
        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * mvPosition;
      }

    </script>
  <script type="text/javascript">
    var scene  = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 20, 500);
    camera.position.z = 350;

    var uniforms1 = {
      time: { type: "f", value: 1.0 },
      resolution: { type: "v2", value: new THREE.Vector2() }
    };


    var material3 = new THREE.ShaderMaterial( {

      uniforms: uniforms1,
      attributes: {
        vertexOpacity: { type: 'f', value: [] }
      },
      vertexShader: document.getElementById( 'vertexShader' ).textContent,
      fragmentShader: document.getElementById( 'fragmentShader1' ).textContent

    } );


    var light = new THREE.AmbientLight(0xffffff); // soft white light
    scene.add(light);

    var light = new THREE.DirectionalLight( '#36648B', 2 );
    light.position.set( 10, 10, 10 ).normalize();
    scene.add(light);

    var light = new THREE.DirectionalLight( '#36648B', 2 );
    light.position.set( -300, 10, 150 ).normalize();
    scene.add(light);

    // var light = new THREE.DirectionalLight( 0x36648B );
    // light.position.set( -10, -10, -10 ).normalize();
    // scene.add(light);

    var canvas = d3.select("body").append("canvas")
      .attr("width", window.innerWidth)
      .attr("height", window.innerHeight);

    canvas.node().getContext("webgl");

    var renderer = new THREE.WebGLRenderer({canvas: canvas.node()});
    renderer.setSize(window.innerWidth, window.innerHeight);

    var material = new THREE.MeshPhongMaterial({ 
      ambient: '#030303', 
      color: '#4183c4', 
      specular: '#009900', 
      shininess: 10
    });

    var material2 = new THREE.MeshPhongMaterial({ 
      ambient: 0x030303, 
      color: 0x000000, 
      specular: 0x009900, 
      shininess: 50
    });

    var geometry = new THREE.CircleGeometry(4, 300); //new THREE.SphereGeometry(10, 200, 200);

    var data = [
      {letter: 'A', frequency: .08167},
      {letter: 'B', frequency: .01492},
      {letter: 'C', frequency: .02780},
      {letter: 'D', frequency: .04253},
      {letter: 'E', frequency: .12702},
      {letter: 'F', frequency: .02288},
      {letter: 'G', frequency: .02022},
      {letter: 'H', frequency: .06094},
      {letter: 'I', frequency: .06973},
      {letter: 'J', frequency: .00153},
      {letter: 'K', frequency: .00747},
      {letter: 'L', frequency: .04025},
      {letter: 'M', frequency: .02517},
      {letter: 'N', frequency: .06749},
      {letter: 'O', frequency: .07507},
      {letter: 'P', frequency: .01929},
      {letter: 'Q', frequency: .00098},
      {letter: 'R', frequency: .05987},
      {letter: 'S', frequency: .06333},
      {letter: 'T', frequency: .09056},
      {letter: 'U', frequency: .02758},
      {letter: 'V', frequency: .01037},
      {letter: 'W', frequency: .02465},
      {letter: 'X', frequency: .00150},
      {letter: 'Y', frequency: .01971},
      {letter: 'Z', frequency: .00074}];



// Object.observe(base.node(), function(changes){

//     // This asynchronous callback runs
//     changes.forEach(function(change) {

//         // Letting us know what changed
//         console.log(change.type, change.name, change.oldValue);
//     });

// });

    var size = [300, 50]

    var x = d3.scale.ordinal()
        .rangeRoundBands([0, size[0]], .2, 1);

    var y = d3.scale.linear()
        .range([size[1], 0]);

    x.domain(data.map(function (d) { return d.letter; }));
    y.domain([0, d3.max(data, function (d) { return d.frequency; })]);

    var base = che.select(scene);

    che.selectObject(base.node())
      .each(function () {
        this.position.set(-(size[0] / 2), 0, 0);
      });

    var bears = base.selectAll(".big.bear")
      .data(data).enter()
      .append("mesh")
      .attr("class", "bear big")
      .attr("material", material3)
      .attr("geometry", function (d) {
        var w = x.rangeBand();
        var h = size[1] - y(d.frequency);
        return new THREE.BoxGeometry(w, h, 4);
      })
      .each(function (d, i) {
        var x0 = x(d.letter);
        var y0 = - y(d.frequency) / 2;
        this.position.set(x0, y0, 240);
      });


      data.sort(function (a, b) { return a.frequency - b.frequency})
      //x.domain(data.map(function (d) { return d.letter; }));

    var bears = base.selectAll(".big.bear")
      .data(data)
      .each(function (d) {
        new TWEEN.Tween(this.position)
          .delay(3000)
          .to({ 
            x: Math.random() * 300, 
            y: Math.random() * 100, 
            z: Math.random() * 300}, 9000 )
          .start();

        new TWEEN.Tween(this.rotation)
          .delay(3000)
          .to({ 
            x: Math.random() * 100, 
            y: Math.random() * 100, 
            z: Math.random() * 100}, 9000)
          .start();
      });





// svg.selectAll(".bar")
//     .data(data)
//   .enter().append("rect")
//     .attr("class", "bar")
//     .attr("x", function(d) { return x(d.letter); })
//     .attr("width", x.rangeBand())
//     .attr("y", function(d) { return y(d.frequency); })
//     .attr("height", function(d) { return height - y(d.frequency); });



    console.log("directive scene", scene);

    // var deers = base.selectAll({material: material})
    //   .attr("material", material2);

    // console.log("deers: ", deers)

    // var theta = 0;
    window.scene = scene;

    var projector = new THREE.Projector();
    var raycaster = new THREE.Raycaster();

    function onMouseDown (event) {
      var mousex =   (event.clientX / window.innerWidth) * 2 - 1;
      var mousey = - (event.clientY / window.innerHeight) * 2 + 1;

      var vector = new THREE.Vector3(mousex, mousey, 1);

      projector.unprojectVector(vector, camera);
      raycaster.ray.set(camera.position, vector.sub(camera.position).normalize());

      var target = raycaster.intersectObjects(bears[0]);

      if (target.length) {
        che.selectObject(target[0].object)
          .attr("material", function (d) {
            if (this.material === material) {
              return material2
            } else {
              return material
            }
          });
      }

      // if (intersects[0].object.material === material2) {
      //   intersects[0].object.material = material;
      // } else {
      //   intersects[0].object.material = material2;
        // intersects[0].object.geometry = 
        // // intersects[0].object.geometry.needsUpdate = true;

      // }

      console.log(target[0].object);
    }

    document.addEventListener('mousedown', onMouseDown, false );

    function render(time) {

      // theta += 0.1;
    TWEEN.update(time);

      // camera.position.x = 300 * Math.sin(THREE.Math.degToRad(theta));
      // camera.position.y = 300 * Math.sin(THREE.Math.degToRad(theta));
      // camera.position.z = 300 * Math.cos(THREE.Math.degToRad(theta));
      // camera.lookAt(scene.position);

      requestAnimationFrame(render);
      renderer.render(scene, camera);
    }
    render();

  </script>
  </body>
</html>