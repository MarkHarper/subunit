<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="../bower_components/threejs/build/three.js"></script>
    <script src="bower_components/d3/d3.js"></script>
    <script src="bower_components/stats.js/build/stats.min.js"></script>
    <script src="../dist/subunit.js"></script>
  </head>
  <style>
    body, html {
      margin: 0px;
    }
  </style>
  <body>
    <script src="https://google.github.io/traceur-compiler/bin/traceur.js"></script>
    <script src="https://google.github.io/traceur-compiler/src/bootstrap.js"></script>
    <script type="module">

      import { camera, scene, renderer, stats } from 'modules/scene';
      import { uvMapper } from 'modules/sprite-uvs';
      import { sphere } from 'modules/layouts';

      d3.json('data/zombies.json', function (err, data) {

        var uvsMap = uvMapper(data.images);

        var sprite = THREE.ImageUtils.loadTexture('images/zombies.jpg');
        var material = new THREE.MeshLambertMaterial({map: sprite, side: THREE.DoubleSide});

        var base = subunit.select(scene);

        var zombies = base.selectAll(".zombie")
          .data(data.images).enter()
          .append("mesh")
            .attr("class", "zombie")
            .attr("material", material)
            .attr("geometry", function (d) {
              var geometry = new THREE.PlaneBufferGeometry(300, 430);
              var uvAttr = new THREE.BufferAttribute(uvsMap(d), 2);

              geometry.addAttribute('uv', uvAttr);

              return geometry;
            })
            .each(function (d, i) {
              var c = sphere(i, data.images.length, 700);

              this.scale.set(0.5, 0.5, 0.5);
              this.position.set(c.pos.x, c.pos.y, c.pos.z);
              this.rotation.set(c.rot.x, c.rot.y, c.rot.z);
            });

        var theta = 0;

        function animate() {
          requestAnimationFrame(animate);
          renderer.render(scene, camera);

          stats.update();

          theta += 0.01;

          base.node().rotation.y = theta;

          zombies.each(function (d) {
            this.rotation.set(theta + 0.01, theta, 0);
          })

        }
        animate();
      });
    </script>
  </body>
</html>